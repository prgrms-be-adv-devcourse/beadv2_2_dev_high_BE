name: Sync main -> develop

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create or update PR main -> develop, enable auto-merge when eligible
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          set -euo pipefail

          LABEL="auto-sync"
          REPO="${GITHUB_REPOSITORY}"

          # (안전장치) 혹시 develop -> main PR이 열려 있으면 중단 (역방향 자동머지 사고 방지)
          BAD_PR="$(gh pr list --repo "$REPO" --base main --head develop --state open --json number --jq '.[0].number' || true)"
          if [ -n "${BAD_PR:-}" ]; then
            echo "ERROR: Open PR develop -> main exists (#$BAD_PR). Close it first."
            exit 1
          fi

          # label 없으면 생성 (이미 있으면 무시)
          gh label create "$LABEL" \
            --description "Auto sync PRs from main to develop" \
            --color "0E8A16" 2>/dev/null || true

          # 이미 열려있는 PR이 있으면 재사용, 없으면 생성
          PR_NUMBER="$(gh pr list --repo "$REPO" \
            --base develop --head main --state open \
            --json number --jq '.[0].number' || true)"

          if [ -z "${PR_NUMBER:-}" ]; then
            PR_URL="$(gh pr create --repo "$REPO" \
              --base develop --head main \
              --title "chore: sync main -> develop" \
              --body "Auto-created after a release push to main." \
              --label "$LABEL")"
            echo "Created PR: $PR_URL"
            PR_NUMBER="$(echo "$PR_URL" | sed -n 's#.*/pull/\([0-9]\+\)$#\1#p')"
          else
            echo "Existing PR: #$PR_NUMBER"
          fi

          # 방향 검증(혹시 뒤집히면 중단)
          BASE="$(gh pr view --repo "$REPO" "$PR_NUMBER" --json baseRefName --jq '.baseRefName')"
          HEAD="$(gh pr view --repo "$REPO" "$PR_NUMBER" --json headRefName --jq '.headRefName')"
          echo "PR #$PR_NUMBER head=$HEAD -> base=$BASE"
          if [ "$BASE" != "develop" ] || [ "$HEAD" != "main" ]; then
            echo "ERROR: PR direction is wrong. Expected head=main base=develop."
            exit 1
          fi

          # 충돌이면 자동머지 걸어도 의미 없으니 PR만 남김
          MERGEABLE="$(gh pr view --repo "$REPO" "$PR_NUMBER" --json mergeable --jq '.mergeable')"
          echo "mergeable=$MERGEABLE"
          if [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "PR #$PR_NUMBER is not mergeable (likely conflict). Leaving it open."
            exit 0
          fi

          # ✅ 핵심: 즉시 머지가 아니라 "요구조건 충족되면 자동머지"를 걸어둠
          # (develop ruleset 때문에 승인/체크 필요하면, 그거 다 끝나면 자동으로 merge됨)
          gh pr merge --repo "$REPO" "$PR_NUMBER" --auto --merge || true
          echo "Auto-merge enabled (if repository allows auto-merge)."
