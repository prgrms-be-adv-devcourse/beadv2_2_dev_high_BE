name: Sync main -> develop

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  issues: write  # label 생성/조회에 필요할 수 있음

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create or update PR main -> develop, enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          set -euo pipefail

          LABEL="auto-sync"

          # label 없으면 생성 (이미 있으면 무시)
          gh label create "$LABEL" \
            --description "Auto sync PRs from main to develop" \
            --color "0E8A16" 2>/dev/null || true

          # 이미 열려있는 PR이 있으면 재사용, 없으면 생성
          PR_NUMBER="$(gh pr list --base develop --head main --state open --json number --jq '.[0].number' || true)"

          if [ -z "${PR_NUMBER:-}" ]; then
            PR_URL="$(gh pr create \
              --base develop \
              --head main \
              --title "chore: sync main -> develop" \
              --body "Auto-created after a release push to main." \
              --label "$LABEL")"
            echo "Created PR: $PR_URL"
            PR_NUMBER="$(echo "$PR_URL" | sed -n 's#.*/pull/\([0-9]\+\)$#\1#p')"
          else
            echo "Existing PR: #$PR_NUMBER"
          fi

          # 요구사항(리뷰/체크) 충족되면 자동으로 머지되게 설정
          gh pr merge "$PR_NUMBER" --auto --merge
